<!doctype html>
<html>
	<head>
		<style>
			body {
				background:#000;
				color: #eee;
				padding:0;
				margin:0;
				font-weight:bold;
				overflow:hidden;

				font-family:Monospace;
				font-size:13px;
				text-align:center;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
				z-index:100;
			}

			a {

				color: #0080ff;
			}

			b { color:orange }
		</style>
	
	</head>
	
	<body>
		<div id="container">
		
		</div>
	</body>
	
	<script type="text/javascript" src="../build/Three.js"></script>
	<script type="text/javascript" src="js/RequestAnimationFrame.js"></script>
	<script type="text/javascript" src="js/Detector.js"></script>
	
	<script>
		var width = window.innerWidth, height = window.innerHeight; //canvas width/height (fullscreen)
		var canvas; //to hold canvas
		var camera, controls, scene, renderer; //webgl initialization elements
		var sphereGeometry;
		var earthMesh, earthMaterial, earthRot = 0.0;
		var cloudMesh, cloudMaterial, cloudRot = 0.0;
		var moonMesh, moonMaterial, moonRot = 0.0, moonRev = 0.0, moonDist = 250;
		var skybox, skyboxTex, cubeTex;
		var directionalLight, ambientLight;
		
		var laserMesh, cylinderGeometry, laserDir, laserDist = 0, laserDuration = 100;
		
		var shipDistance = 10; //distance from camera
		var shipCam, shipScene;
		var ship, shipMesh, shipMaterial;
		
		initWebGL();
		animate();
	
		function initWebGL() {
			if(!Detector.webgl) Detector.addGetWebGLMessage();
			
			//create/tie renderer to canvas
			canvas = document.createElement('div');
			document.body.appendChild(canvas);			
			
			//define renderer
			renderer = new THREE.WebGLRenderer({ clearAlpha: 1, clearColor: 0x000000 }); //create webgl renderer
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setFaceCulling(0);
			renderer.sortObjects = false;
			renderer.autoClear = false;

			canvas.appendChild(renderer.domElement);
			
			
			//create camera and define perspective
			camera = new THREE.PerspectiveCamera(45.0, width/height, 0.1, 100000.0); //create and define camera perspective

			controls = new THREE.FlyControls(camera);
			controls.movementSpeed = 75;
			controls.rollSpeed = 0.2;
			//controls.autoForward = true;

			shipCam = new THREE.PerspectiveCamera(45.0, width/height, 0.1, 100000.0);
			shipCam.position.z = 500;
			
			//create scene
			scene = new THREE.Scene(); //create scene
			shipScene = new THREE.Scene();
			
			

				
			//object/model stuff
			sphereGeometry = new THREE.SphereGeometry(100, 100, 100); //radius/segments/rings	
			cubeGeometry = new THREE.CubeGeometry(10, 10, 10);
			
			//ship
			shipMaterial = new THREE.MeshNormalMaterial({
				color: 0xffffff
			});
			ship = new THREE.Mesh(cubeGeometry, shipMaterial);
			ship.position.z = shipCam.position.z - shipDistance;
			ship.scale.set(0.2, 0.2, 0.2);
			shipScene.add(ship);		
			
			//earth
			earthMaterial = new THREE.MeshPhongMaterial({
				color: 0xffffff,
				map: THREE.ImageUtils.loadTexture("textures/planets/earth_atmos_2048.jpg")
			});	
			earthMesh = new THREE.Mesh(sphereGeometry, earthMaterial);
			earthMesh.position.z = -500;
			shipScene.add(earthMesh);
			
			//clouds
			cloudMaterial = new THREE.MeshPhongMaterial({
				map: THREE.ImageUtils.loadTexture("textures/planets/earth_clouds_1024.png"),
				transparent: true,
				opacity: 0.5
			});
			cloudMesh = new THREE.Mesh(sphereGeometry, cloudMaterial);
			cloudMesh.scale.set(1.005, 1.005, 1.005); //x,y,z
			scene.add(cloudMesh);	
			
			//moon
			moonMaterial = new THREE.MeshPhongMaterial({
				map: THREE.ImageUtils.loadTexture("textures/planets/moon_1024.jpg")
			});
			moonMesh = new THREE.Mesh(sphereGeometry, moonMaterial);
			moonMesh.scale.set(0.3, 0.3, 0.3);
			scene.add(moonMesh);			
/*			
			//laser
			laserDir = new THREE.Vector3();
			laserMaterial = new THREE.MeshNormalMaterial({
				color: 0x666666
			});
			laserMesh = new THREE.Mesh(cubeGeometry, laserMaterial);
			laserMesh.scale.set(0.05, 0.05, 1);
			shipScene.add(laserMesh);
*/			
			//skybox
			skyboxTex = ["textures/cube/skybox/px.jpg", "textures/cube/skybox/nx.jpg", 
						 "textures/cube/skybox/py.jpg", "textures/cube/skybox/ny.jpg",
						 "textures/cube/skybox/pz.jpg", "textures/cube/skybox/nz.jpg"];
			cubeTex = THREE.ImageUtils.loadTextureCube(skyboxTex);

			var shader = THREE.ShaderUtils.lib["cube"];
			shader.uniforms["tCube"].texture = cubeTex;
			var skyboxMaterial = new THREE.ShaderMaterial({
				fragmentShader: shader.fragmentShader,
				vertexShader: shader.vertexShader,
				uniforms: shader.uniforms,
				depthWrite: false
			});
			skybox = new THREE.Mesh(new THREE.CubeGeometry(10000, 10000, 10000), skyboxMaterial);
			skybox.flipSided = true;
			scene.add(skybox);
			
			//lights
			directionalLight = new THREE.DirectionalLight(0xffffff);
			directionalLight.position.set(1.0, 1.0, 1.0);
			directionalLight.position.normalize();
			shipScene.add(directionalLight);
			
			ambientLight = new THREE.AmbientLight(0xffffff);
			shipScene.add(ambientLight);

		}	
			
		function render() {			
			controls.update();
			
			//earth rotation/positioning
			earthMesh.rotation.y = earthRot%360;
			earthRot += 0.0025;
			earthMesh.position.z = -300
			cloudMesh.rotation.y = cloudRot%360;
			cloudRot += 0.005;
			cloudMesh.position.z = -300;
			
			//moon rotation/revolution/positioning
			moonMesh.position.x = moonDist*Math.cos(moonRev);			
			moonMesh.position.z = moonDist*Math.sin(moonRev) - 300;
			//moonMesh.rotation.y = moonRot%360;
			//moonRot += 0.005;
			moonRev += 0.005;
			
			//ship positioning
			ship.position.x = controls.rotationVector.y*2.5;
			ship.position.y = -controls.rotationVector.x*1.25 - 2;
			
				//limit ship rotation
			if(Math.abs(controls.rotationVector.x) < 0.5) {
//				ship.rotation.x = controls.rotationVector.x;
		
			}
			if(Math.abs(controls.rotationVector.y) < 0.5) {
//				ship.rotation.y = controls.rotationVector.y;
			
			}
			
			if(controls.moveState.forward == 1 && ship.position.z > -shipDistance - 5) {
				ship.position.z -= 0.05;
				
			} else if(controls.moveState.forward == 0 && ship.position.z < shipCam.position.z - shipDistance) {
				ship.position.z += 0.075;
				
			}
			

			//laser
/*
			if(laserDist == 0) {
				laserMesh.position.x = shipCam.position.x;
				laserMesh.position.y = shipCam.position.y - 2;
				laserMesh.position.z = shipCam.position.z - shipDistance - 5;
				laserDir.x = controls.rotationVector.y*2.5;
				laserDir.y = -controls.rotationVector.x*1.5;				
			} else {
				laserMesh.position.x += laserDir.x*0.5;
				laserMesh.position.y += laserDir.y*0.5;
				laserMesh.position.z -= 1;
			}
			if(laserDist == laserDuration) {
				laserDist = 0;
			}
			laserDist += 1;			
*/		
			
			renderer.clear();
			
			renderer.render(shipScene, shipCam);					
			renderer.render(scene, camera);
	
		}		
		
		
		function animate() {
			render();
			requestAnimationFrame(animate);
		}
			

			
	</script>
</html>