<div id="ship">
</div>
<div id="stats">
</div>
    <script type="text/javascript" src="build/Three.r48.js"></script>
<script>
function populate(lasers) {
    for(var i in lasers) {
        sceneElements.lasers[0].children.push({
            parent:null,
            position:lasers[i],
            spheres:{"outer":{"x":0,"y":0,"z":0,"r":10},"inner":[]}
        });
    }
}
function frame() {
    document.getElementById('ship').innerHTML = "position: "+sceneElements.mainShip.position.x+"x"+sceneElements.mainShip.position.y+"x"+sceneElements.mainShip.position.z;
    var mhits = collision(sceneElements.mainShip);
    if(mhits.length) {
        document.getElementById('ship').innerHTML += " HIT";
    }
    document.getElementById('stats').innerHTML = "";
    for(var i in sceneElements.AIShips){
        var e = document.createElement('div');
        e.id = 'ai'+i;
        e.innerHTML = 'AI '+i+': '+sceneElements.AIShips[i].position.x+"x"+sceneElements.AIShips[i].position.y+"x"+sceneElements.AIShips[i].position.z;
        document.getElementById('stats').appendChild(e);
    }
    for(var i in sceneElements.lasers){
        for(var j in sceneElements.lasers[i].children){
            var e = document.createElement('div');
            e.id = 'laser'+i+""+j;
            e.innerHTML = 'laser '+i+'-'+j+': '+sceneElements.lasers[i].children[j].position.x+"x"+sceneElements.lasers[i].children[j].position.y+"x"+sceneElements.lasers[i].children[j].position.z;
            document.getElementById('stats').appendChild(e);
        }
    }
}
var interv = setInterval(frame, 1000);
var sceneElements = {
    mainShip: {position:{"x":0.0,"y":0.0,"z":0.0},gameParameters:{"spheres":{"outer":{"x":0,"y":0,"z":0,"r":30},"inner":[]}}},
    AIShips: [{position:{"x":0.0,"y":0.0,"z":-300.0},gameParameters:{"spheres":{"outer":{"x":0,"y":0,"z":0,"r":30},"inner":[]}}}, {position:{"x":300.0,"y":0.0,"z":0.0},gameParameters:{"spheres":{"outer":{"x":0,"y":0,"z":0,"r":30},"inner":[]}}}],
    lasers: [{children:[]}],
    missiles: []
}
populate([{x:0,y:0,z:0}]);
function cAdd(coords1, coords2){
    var coords = {};
    for(a in coords1){
        if(a != 'x' && a != 'y' && a != 'z'){
            coords[a] = coords1[a];
        }
    }
    coords.x = (coords1.x + coords2.x);
    coords.y = (coords1.y + coords2.y);
    coords.z = (coords1.z + coords2.z);
    return coords;
}
function intersect(obj1, obj2){
    var xd = obj1.x - obj2.x,
        yd = obj1.y - obj2.y,
        zd = obj1.z - obj2.z,
        rr = obj1.r + obj2.r;
    var actualDistance = (xd * xd) + (yd * yd) + (zd * zd),
        minDistance = (rr * rr);
    if(actualDistance <= minDistance){
        // a hit!
        var hitLocation = new THREE.Vector3(xd, yd, zd);
        hitLocation.normalize();
        //console.log('obj1:'+obj1.x+'x'+obj1.y+'x'+obj1.z+'r'+obj1.r+' obj2:'+obj2.x+'x'+obj2.y+'x'+obj2.z+'r'+obj2.r+' hit:'+(hitLocation.x * obj2.r)+'x'+(hitLocation.y * obj2.r)+'x'+(hitLocation.z * obj2.r));
        return {x:(hitLocation.x * obj2.r), y:(hitLocation.y * obj2.r), z:(hitLocation.z * obj2.r)};
    }
    //console.log('obj1:'+obj1.x+'x'+obj1.y+'x'+obj1.z+'r'+obj1.r+' obj2:'+obj2.x+'x'+obj2.y+'x'+obj2.z+'r'+obj2.r+' miss');
    return false;
}
function collision(obj){
    var hits = [];
    var objects = [];
    objects.push(sceneElements.mainShip);
    //console.log(objects.length);
    //console.log(sceneElements.AIShips.length);
    objects = objects.concat(sceneElements.AIShips);
    //console.log(objects.length);
    for(var i in sceneElements.lasers) {
        objects = objects.concat(sceneElements.lasers[i].children);
        //console.log(objects.length);
    }
    objects = objects.concat(sceneElements.missiles);
    //console.log(objects.length);
    // go through each object in the scene
    for(candidate in objects){
        // don't check against itself
        if((objects[candidate].hasOwnProperty('fired') && objects[candidate].fired && objects[candidate].parent.parentShip != obj) // it's an active laser
                || (objects[candidate] !== obj && !objects[candidate].hasOwnProperty('fired'))){ // it's another object
            //console.log('not me, not an unfired laser');
            // check if there are spheres
            var cspheres = undefined, ospheres = undefined;
            if(typeof objects[candidate].gameParameters == "object" && typeof objects[candidate].gameParameters.spheres == "object") {
                cspheres = objects[candidate].gameParameters.spheres;
            }
            else if(typeof objects[candidate].spheres == "object") {
                cspheres = objects[candidate].spheres;
            }
            if(typeof obj.gameParameters == "object" && typeof obj.gameParameters.spheres == "object") {
                ospheres = obj.gameParameters.spheres;
            }
            else if(typeof obj.spheres == "object") {
                ospheres = obj.spheres;
            }
            if(typeof cspheres == "object" && typeof cspheres.outer == "object" && typeof ospheres == "object" && typeof ospheres.outer == "object"){
                //console.log('spheres present');
                // check outer.gameParameters.spheres
                var oHit = intersect(cAdd(cspheres.outer, objects[candidate].position), cAdd(ospheres.outer, obj.position));
                if(oHit){
                    console.log('hit!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!');
                    // check for inner.gameParameters.spheres
                    var check = false,
                        cand = [cspheres.outer],
                        subj = [ospheres.outer];
                    if(typeof cspheres.inner == "object" && cspheres.inner.length != 0){
                        check = true;
                        cand = cspheres.inner;
                    }
                    if(typeof ospheres.inner == "object" && ospheres.inner.length != 0){
                        check = true;
                        subj = ospheres.inner;
                    }
                    // check inner spheres
                    if(check){
                        for(c in cand){
                            for(s in subj){
                                var iHit = intersect(cAdd(cand[c], objects[candidate].position), cAdd(subj[s], obj.position));
                                if(iHit){
                                    hits.push({where:iHit, obj:objects[candidate]});
                                }
                            }
                        }
                    }
                    // don't check innder spheres; mark as collision
                    else{
                        hits.push({where:oHit, obj:objects[candidate]});
                    }
                }
            }
        }
    }
    return hits;
}
</script>
