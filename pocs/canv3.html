<canvas width="900" height="400" id="canvas">blah</canvas>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript">
	var CW = canvas.width,
		HCW = canvas.width/2,
		CH = canvas.height,
		HCH = canvas.height/2;
	function dist(x1,y1,x2,y2) {
		return Math.sqrt(Math.pow((x2-x1),2)+Math.pow((y2-y1),2));
	}
	function Space() {
		this.landmarks = [];
	}
	Space.prototype.draw = function () {
		ctx.fillRect(0,0,CW,CH);
		this.ministars();
	}
	Space.prototype.ministars = (function () {
		var i, j, stars = [[],[],[]];
		for(i = 0; i < 15; i++){
			stars[0].push({
				x:Math.random() * CW,
				y:Math.random() * CH
			});
		}
		for(i = 0; i < 10; i++){
			stars[1].push({
				x:Math.random() * CW,
				y:Math.random() * CH
			});
		}
		for(i = 0; i < 30; i++){
			stars[2].push({
				x:Math.random() * CW,
				y:Math.random() * CH
			});
		}
		return function () {
			ctx.save();
			ctx.fillStyle = '#fff';
			for(i in stars){
				for(j in stars[i]){
					ctx.fillRect(stars[i][j].x, stars[i][j].y, 2, 2);
				}
			}
			ctx.restore();
		};
	}());
	function Immovable() {
		this.x = 0;
		this.y = 0;
		this.team = 0;
	}
	Immovable.prototype.draw = function () {
		
	}
	function Ship() {
		//position and velocity
		this.x = HCW;
		this.y = HCH;
		this.vel = 0;
		this.orientation = 0;
		//ship stats
		this.maxspeed = 10;
		this.range = 100;
		this.firepower = 10;
		this.maxhealth = 100;
		this.health = this.maxhealth;
		this.firecost = 10;
		this.maxcharge = 100;
		this.charge = this.maxcharge;
		this.reload = 1;
		//enemy
		this.target = null;
	}
	Ship.prototype.setVelocity = function (ds){
		if(ds){
			if(this.vel < this.maxspeed){
				this.vel += 1;
			}
		}
		else{
			this.vel -= 1;
			if(this.vel < 0){
				this.vel = 0;
			}
		}
	};
	Ship.prototype.setOrientation = function (dir){
		var amt = Math.PI/18;
		if(dir > 0){
			this.orientation += amt;
			if(this.orientation > Math.PI * 2){
				this.orientation = 0;
			}
		}
		else{
			this.orientation -= amt;
			if(this.orientation < 0){
				this.orientation = Math.PI * 2;
			}
		}
	};
	Ship.prototype.updateShip = function () {
		this.acquireTarget();
		this.updateStatus();
		this.updateVelocity();
		if(typeof this.drawStatus == "function"){
			this.drawStatus();
		}
		this.draw();
	};
	Ship.prototype.draw = function (){
		ctx.fillStyle = '#fff';
		ctx.save();
		
		ctx.translate(this.x,this.y);
		
		ctx.fillText(this.health, -10,-20);
		ctx.rotate(this.orientation);
		
		ctx.beginPath();
		ctx.moveTo(-10, -5);
		ctx.lineTo(-10, 5);
		ctx.lineTo(10, 0);
		ctx.closePath();
		ctx.fillStyle = '#00f';
		ctx.fill();
		ctx.strokeStyle = '#fff';
		ctx.stroke();
		
		if(this.vel){
			//ctx.fillRect(-10,-5, -10,10);
			var farback = -(10+this.vel*1.5);
			ctx.beginPath();
			ctx.moveTo(-10,-3);
			ctx.lineTo(farback,-5);
			ctx.lineTo(farback,0);
			ctx.fillStyle = 'orange';
			ctx.fill();
			ctx.beginPath();
			ctx.moveTo(-10,3);
			ctx.lineTo(farback,5);
			ctx.lineTo(farback,0);
			ctx.fill();
		}
		
		ctx.restore();
	};
	Ship.prototype.acquireTarget = function () {
		this.target = null;
		for(i in enemies){
			var e = enemies[i].dradis();
			var d = dist(this.x,this.y,e.x,e.y);
			if(d <= this.range){
				if(this.target === null || d < this.target.dist){
					e.dist = d;
					if(typeof this.targetStatus == "function"){
						this.targetStatus(e);
					}
				}
			}
		}
	};
	Ship.prototype.shoot = function () {
		if(this.target && this.charge > this.firecost - 1){
			//draw weapon beam
			ctx.save();
			
			ctx.beginPath();
			ctx.moveTo(x,y);
			ctx.lineTo(this.target.x,this.target.y);
			ctx.strokeStyle = '#f00';
			ctx.lineWidth = 3;
			ctx.stroke();
			
			ctx.restore();
			
			//draw energy from weapon
			this.charge -= this.firecost;
			
			//hit enemy
			this.target.hit(firepower);
		}
	};
	Ship.prototype.hit = function (damage) {
		this.health -= damage;
		if(this.health <= 0){
			this.draw = function () {
				ctx.fillText('You are dead.', HCW, HCH);
			};
			this.dradis = function () {
				return {x:-9999,y:-9999,hit:function (){}};
			};
			this.vel = 0;
		}
	};
	Ship.prototype.updateStatus = function () {
		//weapons status
		if(this.charge < this.maxcharge){
			this.charge += this.reload;
			if(this.charge > this.maxcharge){
				this.charge = this.maxcharge;
			}
		}
		//health status
		if(this.health < this.maxhealth){
			this.health++;
		}
	};
	Ship.prototype.updateVelocity = function () {
		//update position
		this.x += this.vel * Math.cos(this.orientation);
		this.y += this.vel * Math.sin(this.orientation);
		//wrap around the board
		if(this.x < 0){this.x = CW;}
		else if(this.x > CW){this.x = 0;}
		if(this.y < 0){this.y = CH;}
		else if(this.y > CH){this.y = 0;}
	};
	Ship.prototype.dradis = function () {
		return {x:this.x,y:this.y,hit:this.hit};
	};
	
	function Player(team) {
		this.team = team;
	}
	Player.prototype = new Ship();
	Player.prototype.drawStatus = function () {
		ctx.fillStyle = '#fff';
		ctx.save();
		
		ctx.fillText('x:'+this.x,10,20);
		ctx.fillText('y:'+this.y,10,30);
		ctx.fillText('vel:'+this.vel,10,40);
		ctx.fillText('orien:'+this.orientation,10,60);
		ctx.fillText('keys:'+this.keyers, 10, 70);
		ctx.fillText('WEAPONS:',10,80);
		ctx.fillText('HEALTH:',10,90);
		//WEAPONS
		ctx.fillStyle = '#f00';
		ctx.strokeStyle = '#f00';
		ctx.fillRect(70,80, this.charge/this.maxcharge * 100, -7);
		ctx.strokeRect(70,80, 100, -7);
		//HEALTH
		ctx.fillStyle = '#0f0';
		ctx.strokeStyle = '#0f0';
		ctx.fillRect(60,90, this.health/this.maxhealth * 100, -7);
		ctx.strokeRect(60,90, 100, -7);
		
		ctx.restore();
	};
	Ship.prototype.targetStatus = function (e) {
		this.target = e;
		ctx.save();
		ctx.fillText('TARGET', e.x-20, e.y+20);
		ctx.beginPath();
		ctx.arc(e.x,e.y,30,0,Math.PI*2,true);
		ctx.strokeStyle = '#ff0000';
		ctx.stroke();
		ctx.restore();
	};
	
	function Robot(team) {
		this.team = team;
		//position and velocity
		this.x = Math.random() * CW;
		this.y = Math.random() * CH;
		this.vel = 0;
		this.orientation = Math.PI * 2 + 3;
		//ship stats
		this.maxspeed = 10;
		this.range = 100;
		this.firepower = 5;
		this.maxhealth = 150;
		this.health = this.maxhealth;
		this.firecost = 10;
		this.maxcharge = 100;
		this.charge = this.maxcharge;
		this.reload = 1;
		//enemy
		this.target = null;
		//AI numbers
		this.coursechange = 30;
	}
	Robot.prototype = new Ship();
	Robot.prototype.brain = function () {
		//course
		if(this.coursechange === 0){
			this.coursechange = 30;
			this.orientation = Math.random() * Math.PI * 2;
			this.vel = Math.random() * this.maxspeed/2 + this.maxspeed/2;
		}
		else{
			this.coursechange--;
		}
		//tactical
		//console.log(target);
		if(this.target && this.charge > 0){
			this.shoot();
		}
	}
	
	
	function removeEnemy(which) {
		for(i in enemies){
			if(enemies[i].id === which){
				enemies.splice(i,1);
			}
		}
	}
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	ctx.fillStyle = '#fff';
	ctx.strokeStyle = '#fff';
	var space = new Space();
	var ship = new Player(0);
	var enemies = [];
	/*enemies.push(new Robot(1));*/
	var keyers = [];
	function go() {
		canvas.width = CW;
		space.draw();
		ship.updateShip();
		/*for(i in enemies){
			enemies[i].updateShip();
		}
		ctx.fillText('enemies:'+enemies.length, 10, 100);*/
		for(i in keyers){
			switch(keyers[i]){
				case 38:
					ship.setVelocity(1);
					break;
				case 40:
					ship.setVelocity(0);
					break;
				case 39:
					ship.setOrientation(1);
					break;
				case 37:
					ship.setOrientation(-1);
					break;
				case 32:
					ship.shoot();
					break;
			}
		}
	}
	timer = setInterval(go, 30);
	$(window).keydown(function (e) {
		if(keyers.indexOf(e.keyCode)==-1 && typeof e.keyCode){keyers.push(e.keyCode);}
		if(e.keyCode === 38 || e.keyCode === 40 || e.keyCode === 32){
			return false;
		}
	});
	$(window).keyup(function (e) {
		keyers.splice(keyers.indexOf(e.keyCode), 1);
	});
</script>
