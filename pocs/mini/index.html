<canvas width="900" height="400" id="canvas" style="margin:10px auto;">blah</canvas>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="ships.js"></script>
<script type="text/javascript" src="immovables.js"></script>
<script type="text/javascript" src="displays.js"></script>
<script type="text/javascript">
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	ctx.fillStyle = '#fff';
	ctx.strokeStyle = '#fff';
	var CW = canvas.width,
		HCW = canvas.width/2,
		CH = canvas.height,
		HCH = canvas.height/2,
		EDGES = 100;
	function dist(x1,y1,x2,y2) {
		return Math.sqrt(Math.pow((x2-x1),2)+Math.pow((y2-y1),2));
	}
	function rando(min, max, floor) {
		var r = Math.random() * (max - min) + min;
		if(floor){
			r = Math.floor(r);
		}
		return r;
	}
	
	function Space() {
		this.landmarks = [];
		this.pl = new Player();
		this.pl.parent = this;
		this.planets = [];
		this.planets.push(new Planet(300, 900, 150));
		this.planets.push(new Planet(-500, -1570, 175));
		this.planets.push(new Planet(609, -70, 90));
	}
	Space.prototype.cycle = function () {
		var i;
		this.draw();
		for(i in this.planets){
			this.planets[i].draw(this.pl.x, this.pl.y);
		}
		this.pl.cycle();
		if(this.pl.vel){
			this.ministars.update(this.pl.orientation, this.pl.vel);
		}
	}
	Space.prototype.draw = function () {
		ctx.fillRect(0,0,CW,CH);
		this.ministars.draw();
	}
	Space.prototype.ministars = (function () {
		var i, j, stars = [[],[],[],[]], quants = [10, 20, 20, 40];
		function generate() {
			return {
				x:Math.random() * (CW + EDGES * 2) - EDGES,
				y:Math.random() * (CH + EDGES * 2) - EDGES
			};
		}
		//fastest to slowest
		for(i in stars){
			for(j = 0; j < quants[i]; j++){
				stars[i].push(generate());
			}
		}
		function change(star, dx, dy, amt) {
			star.x -= dx * amt;
			star.y -= dy * amt;
			if(star.x < -EDGES){
				star.x = CW + EDGES;
				star.y = Math.random() * (CH + EDGES * 2) - EDGES;
			}
			else if(star.x > CW + EDGES){
				star.x = -EDGES;
				star.y = Math.random() * (CH + EDGES * 2) - EDGES;
			}
			if(star.y < -EDGES){
				star.x = Math.random() * (CW + EDGES * 2) - EDGES;
				star.y = CH + EDGES;
			}
			else if(star.y > CH + EDGES){
				star.x = Math.random() * (CW + EDGES * 2) - EDGES;
				star.y = -EDGES;
			}
		}
		return {
			update: function (direction, speed) {
				var dx = Math.cos(direction);
				var dy = Math.sin(direction);
				for(i in stars){
					for(j in stars[i]){
						change(stars[i][j], dx, dy, speed/(i+2));
					}
				}
			},
			draw: function () {
				ctx.save();
				ctx.fillStyle = '#fff';
				for(i in stars){
					for(j in stars[i]){
						ctx.fillRect(stars[i][j].x, stars[i][j].y, 2, 2);
					}
				}
				ctx.restore();
			}
		};
	}());
	
	var space = new Space();
	var hud = new HUD();
	var map = new Map(space);
	var keyers = [];
	function go() {
		canvas.width = CW;
		space.cycle();
		hud.draw();
		map.draw();
		for(i in keyers){
			switch(keyers[i]){
				case 38:
					space.pl.adjustVelocity(1);
					break;
				case 40:
					space.pl.adjustVelocity(0);
					break;
				case 39:
					space.pl.setOrientation(1);
					break;
				case 37:
					space.pl.setOrientation(-1);
					break;
				case 32:
					space.pl.shoot();
					break;
			}
		}
	}
	timer = setInterval(go, 30);
	$(window).keydown(function (e) {
		if(keyers.indexOf(e.keyCode)==-1 && typeof e.keyCode){keyers.push(e.keyCode);}
		if(e.keyCode === 38 || e.keyCode === 40 || e.keyCode === 32){
			return false;
		}
	});
	$(window).keyup(function (e) {
		keyers.splice(keyers.indexOf(e.keyCode), 1);
	});
</script>
